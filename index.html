<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帮助我们战胜机器人</title>
  <link rel="stylesheet" href="https://unpkg.com/mdui@1.0.2/dist/css/mdui.min.css">
  <style>
    .center {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
  </style>
</head>

<body class="mdui-theme-primary-indigo mdui-theme-accent-pink">
  <div class="center">
    <div class="mdui-card" style="width: 400px;">
      <div class="mdui-card-primary">
        <div class="mdui-card-primary-title">帮助我们战胜机器人</div>
        <div class="mdui-card-primary-subtitle">Nightly 1 | 使用PoW工作量证明确认你是人类</div>
      </div>
      <div class="mdui-card-content">
        <div class="mdui-textfield">
          <input class="mdui-textfield-input" type="text" id="dataInput"
            placeholder="[Nightly ONLY]输入数据（默认：Hello World）" />
        </div>
        <div class="mdui-progress">
          <div id="progress" class="mdui-progress-indeterminate" style="display: none;"></div>
        </div>
        <p id="status">等待开始...</p>
        <p id="eta"></p>
        <p id="nonce"></p>
        <p id="hash"></p>
      </div>
      <div class="mdui-card-actions">
        <button id="startBtn" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent">开始挖矿</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/mdui@1.0.2/dist/js/mdui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

  <script>
    const startBtn = document.getElementById('startBtn');
    const progressBar = document.getElementById('progress');
    const statusText = document.getElementById('status');
    const etaText = document.getElementById('eta');
    const nonceText = document.getElementById('nonce');
    const hashText = document.getElementById('hash');
    const dataInput = document.getElementById('dataInput');

    startBtn.addEventListener('click', startProofOfWork);

    function startProofOfWork() {
      startBtn.disabled = true;
      progressBar.style.display = 'block';
      statusText.textContent = "正在进行工作量证明...";
      etaText.textContent = "计算ETA中...";
      nonceText.textContent = "";
      hashText.textContent = "";

      const data = dataInput.value || "Hello World";
      let nonce = 0;
      let difficulty = 1; // 初始难度
      const targetTime = 60; // 目标时间为60秒
      const startTime = Date.now();
      let lastUpdateTime = startTime;
      let lastUpdateNonce = 0;
      let hashRate = 0;

      function updateDifficulty() {
        const currentTime = Date.now();
        const elapsedTime = (currentTime - startTime) / 1000; // 总共经过的秒数
        const hashesComputed = nonce;
        hashRate = hashesComputed / elapsedTime; // 平均哈希率

        // 根据哈希率和目标时间调整难度
        const expectedHashes = hashRate * targetTime;
        difficulty = Math.max(1, Math.floor(Math.log(expectedHashes) / Math.log(16)));

        // 更新目标
        target = "0".repeat(difficulty);

        // 更新显示
        etaText.textContent = `当前难度: ${difficulty}`;
        etaText.title = `平均哈希率: ${hashRate.toFixed(2)} H/s`;
      }

      function updateStatus() {
        const currentTime = Date.now();
        const elapsedTime = (currentTime - lastUpdateTime) / 1000; // 秒
        const hashesSinceLastUpdate = nonce - lastUpdateNonce;
        const currentHashRate = hashesSinceLastUpdate / elapsedTime;

        statusText.textContent = `尝试次数: ${nonce.toLocaleString()}`;
        nonceText.textContent = `当前哈希率: ${currentHashRate.toFixed(2)} H/s`;

        lastUpdateTime = currentTime;
        lastUpdateNonce = nonce;
      }

      function mine() {
        const batchSize = 10000;
        for (let i = 0; i < batchSize; i++) {
          const hash = sha256(data + nonce);
          if (hash.startsWith(target)) {
            const endTime = Date.now();
            const duration = (endTime - startTime) / 1000; // 转换为秒
            progressBar.style.display = 'none';
            statusText.textContent = `工作量证明完成! 用时: ${duration.toFixed(2)}秒`;
            etaText.textContent = "";
            nonceText.textContent = `Nonce: ${nonce.toLocaleString()}`;
            hashText.textContent = `Hash: ${hash}`;
            startBtn.textContent = '继续';
            startBtn.classList.remove('mdui-color-theme-accent');
            startBtn.classList.add('mdui-color-green');
            startBtn.disabled = false;
            startBtn.onclick = () => {
              window.location.href = 'https://dqjl.eu.org';
            };
            clearInterval(statusInterval);
            clearInterval(difficultyInterval);
            return;
          } else {
            nonce++;
          }
        }
        // 继续挖矿
        setTimeout(mine, 0);
      }

      // 开始挖矿
      let target = "0".repeat(difficulty);
      mine();

      // 每秒更新状态
      const statusInterval = setInterval(updateStatus, 1000);

      // 每5秒调整一次难度
      const difficultyInterval = setInterval(updateDifficulty, 5000);
    }
  </script>
</body>

</html>
