<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>帮助我们战胜机器人</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui/dist/css/mdui.min.css">
  <style>
    .center {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .hash-display {
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
    }
  </style>
</head>

<body class="mdui-theme-primary-indigo mdui-theme-accent-pink">
  <div class="center">
    <div class="mdui-card" style="width: 400px;">
      <div class="mdui-card-primary">
        <div class="mdui-card-primary-title">帮助我们战胜机器人</div>
        <div class="mdui-card-primary-subtitle">使用工作量证明确认你是人类</div>
      </div>
      <div class="mdui-card-content">
        <div class="mdui-progress">
          <div id="progress" class="mdui-progress-indeterminate" style="display: none;"></div>
        </div>
        <p id="status">等待开始...</p>
        <p id="eta"></p>
        <p id="nonce"></p>
        <p id="hash" class="hash-display"></p>
      </div>
      <div class="mdui-card-actions">
        <button id="startBtn" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent">开始挖矿</button>
        <button id="pauseBtn" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-orange" style="display: none;">暂停</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/mdui/dist/js/mdui.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>

  <script>
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const progressBar = document.getElementById('progress');
    const statusText = document.getElementById('status');
    const etaText = document.getElementById('eta');
    const nonceText = document.getElementById('nonce');
    const hashText = document.getElementById('hash');

    let worker;
    let mining = false;
    let paused = false;

    startBtn.addEventListener('click', startProofOfWork);
    pauseBtn.addEventListener('click', pauseOrResume);

    function startProofOfWork() {
      if (mining) return;

      mining = true;
      paused = false;
      startBtn.disabled = true;
      pauseBtn.style.display = 'inline-block';
      pauseBtn.textContent = '暂停';
      progressBar.style.display = 'block';
      statusText.textContent = "正在进行工作量证明...";
      etaText.textContent = "计算ETA中...";
      nonceText.textContent = "";
      hashText.textContent = "";

      const difficulty = 1500000;

      if (worker) {
        worker.terminate();
      }

      worker = new Worker('minerWorker.js');
      worker.postMessage({ difficulty });

      worker.onmessage = function (e) {
        const data = e.data;

        if (data.type === 'progress') {
          statusText.textContent = `尝试次数: ${data.nonce.toLocaleString()}`;
          etaText.textContent = `预计完成时间: ${data.eta}`;
          etaText.title = `当前哈希率: ${data.hashRate.toFixed(2)} H/s, 平均哈希率: ${data.averageHashRate.toFixed(2)} H/s`;
        }

        if (data.type === 'result') {
          mining = false;
          progressBar.style.display = 'none';
          statusText.textContent = "";
          etaText.textContent = "";
          nonceText.textContent = `Nonce: ${data.nonce.toLocaleString()}`;
          hashText.textContent = `Hash: ${data.hash}`;
          startBtn.style.display = 'none';
          pauseBtn.style.display = 'none';
        }
      };
    }

    function pauseOrResume() {
      if (!mining) return;

      if (!paused) {
        worker.postMessage({ action: 'pause' });
        paused = true;
        pauseBtn.textContent = '继续';
        statusText.textContent = '已暂停';
      } else {
        worker.postMessage({ action: 'resume' });
        paused = false;
        pauseBtn.textContent = '暂停';
        statusText.textContent = '正在进行工作量证明...';
      }
    }
  </script>
</body>

</html>
